{% extends 'base.html' %}

{% block title %}{% if object %}Edit Entry{% else %}New Entry{% endif %} | Journal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with Breadcrumbs/Back -->
    <div class="mb-10 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{% url 'book-detail' book.id %}" class="flex items-center justify-center w-10 h-10 rounded-full border border-zinc-800 bg-zinc-900/50 hover:bg-zinc-800 transition-all text-zinc-400 hover:text-zinc-50">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-zinc-50">
                    {% if object %}Edit Entry{% else %}Write New Entry{% endif %}
                </h1>
                <p class="text-zinc-500 text-sm mt-1">In collection: <span class="text-zinc-400">{{ book.title }}</span></p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
             <div id="check-status" class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-[10px] font-mono text-zinc-500">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                Checking Grammar...
             </div>
             <button id="refine-ai" type="button" class="hidden md:flex items-center gap-2 px-4 py-1.5 rounded-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-xs font-bold text-zinc-300 transition-all hover:text-zinc-50">
                <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
                Refine All
             </button>
        </div>
    </div>

    <!-- The Editor Container -->
    <form id="editor-form" method="post" class="space-y-8">
        {% csrf_token %}
        {{ form.mood }}
        {{ form.spotify_track_id }}

        <!-- Mood & Spotify Top Bar -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 p-6 rounded-3xl bg-zinc-900/30 border border-zinc-800/50 backdrop-blur-sm">
            <div class="w-full md:w-auto">
                <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3 block">Current Mood</label>
                <div class="flex flex-wrap gap-2" id="mood-picker">
                    <button type="button" data-mood="happy" title="Happy" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ˜Š</button>
                    <button type="button" data-mood="sad" title="Sad" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ˜¢</button>
                    <button type="button" data-mood="energetic" title="Energetic" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">âš¡</button>
                    <button type="button" data-mood="calm" title="Calm" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ§˜</button>
                    <button type="button" data-mood="romantic" title="Romantic" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ’–</button>
                    <button type="button" data-mood="productive" title="Productive" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸš€</button>
                </div>
            </div>

            <div class="w-full md:w-1/3">
                <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3 block">Sync Spotify Song</label>
                <div class="relative">
                    <i data-lucide="music" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-600"></i>
                    <input 
                        type="text" 
                        id="spotify-search" 
                        placeholder="Paste Track ID or Search..." 
                        class="w-full bg-zinc-950 border border-zinc-800 rounded-xl py-2 pl-10 pr-4 text-sm text-zinc-300 focus:border-green-500/50 focus:ring-1 focus:ring-green-500/20 transition-all outline-none"
                    >
                    <div id="spotify-preview" class="hidden mt-2 p-2 rounded-lg bg-zinc-950/50 border border-zinc-900 flex items-center gap-3">
                        <div class="w-10 h-10 rounded bg-zinc-800 animate-pulse" id="track-art"></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-bold text-zinc-300 truncate" id="track-name">Loading...</p>
                            <p class="text-[10px] text-zinc-500 truncate" id="track-artist">Artist</p>
                        </div>
                        <button type="button" id="remove-track" class="text-zinc-600 hover:text-red-400">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="relative group">
            <input 
                type="text" 
                name="title" 
                id="id_title" 
                maxlength="200" 
                required 
                placeholder="Entry Title..."
                value="{{ form.title.value|default_if_none:'' }}"
                class="w-full bg-transparent border-none text-4xl md:text-5xl font-black text-zinc-50 placeholder:text-zinc-900 focus:ring-0 focus:outline-none transition-all"
            >
        </div>

        <div class="relative min-h-[400px]">
            <!-- Hidden textarea for Django submission -->
            <textarea name="content" id="id_content" class="hidden">{{ form.content.value|default_if_none:'' }}</textarea>
            
            <!-- ContentEditable Div: The actual editor with spellcheck -->
            <div 
                id="real-editor" 
                contenteditable="true" 
                spellcheck="true"
                placeholder="Start your story here..."
                class="w-full min-h-[400px] bg-transparent border-none text-lg md:text-xl leading-relaxed text-zinc-300 placeholder:text-zinc-800 focus:ring-0 focus:outline-none outline-none whitespace-pre-wrap"
            >{{ form.content.value|default_if_none:'' }}</div>
            
            <!-- Floating Popup for Correction -->
            <div id="correction-popup" class="hidden absolute z-[60] bg-zinc-900 border border-zinc-800 shadow-2xl rounded-xl p-2 min-w-[200px]">
                <div class="text-[10px] text-zinc-500 font-mono mb-2 px-2 uppercase tracking-tighter">Suggestion</div>
                <div id="suggestion-container" class="space-y-1"></div>
            </div>
        </div>

        <!-- Sticky Bottom Bar -->
        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-lg px-4 z-50">
            <div class="bg-zinc-950/90 backdrop-blur-xl border border-zinc-800 p-2 rounded-2xl shadow-2xl flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 pl-4">
                    <div class="flex flex-col">
                        <span id="word-count" class="text-[10px] font-mono text-zinc-600 uppercase">0 Words</span>
                        <span id="issue-count" class="text-[9px] font-mono text-zinc-400 uppercase">Clear</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <a href="{% url 'book-detail' book.id %}" class="px-4 py-2 text-sm font-medium text-zinc-500 hover:text-zinc-50 transition-colors">
                        Discard
                    </a>
                    <button type="submit" class="bg-emerald-500 text-zinc-950 px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-emerald-400 transition-all shadow-[0_0_20px_rgba(16,185,129,0.2)] hover:scale-[1.02] active:scale-[0.98] flex items-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        {% if object %}Save Change{% else %}Publish Entry{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* ContentEditable Placeholder Effect */
    [contenteditable]:empty:before {
        content: attr(placeholder);
        color: #18181b; /* zinc-900 */
        cursor: text;
    }
    
    /* Error Underlining style */
    .grammarly-error {
        border-bottom: 2px solid #ef4444; /* red-500 */
        cursor: pointer;
        background: rgba(239, 68, 68, 0.1);
    }
    .spelling-error {
        border-bottom: 2px dashed #f59e0b; /* amber-500 */
        cursor: pointer;
    }

    /* Hide scrollbar */
    #real-editor::-webkit-scrollbar { display: none; }

    .mood-btn.active-mood {
        opacity: 1 !important;
        filter: grayscale(0) !important;
        background-color: rgba(24, 24, 27, 0.8);
        border-color: #3f3f46;
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.05);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const editor = document.getElementById('real-editor');
        const hiddenContent = document.getElementById('id_content');
        const wordCountDisplay = document.getElementById('word-count');
        const issueCountDisplay = document.getElementById('issue-count');
        const checkStatus = document.getElementById('check-status');

        const moodInput = document.getElementById('id_mood');
        const spotifyInput = document.getElementById('id_spotify_track_id');
        const moodBtns = document.querySelectorAll('.mood-btn');
        const spotifySearch = document.getElementById('spotify-search');
        const spotifyPreview = document.getElementById('spotify-preview');
        const removeTrackBtn = document.getElementById('remove-track');

        const MOOD_TRACKS = {
            'happy': '60n9v9rvR0qG00T8p99Y8T', // Example: Feels like Summer
            'sad': '767YV0O9p9iInY5TqI7H9y', 
            'energetic': '2v99Wv1Hps6Ym5yW7FhS1q',
            'calm': '3EB0X9u6l9XvX1mY4E3v1f',
            'romantic': '168CIn2S8R6SpsRvewDSsy',
            'productive': '50V9G0O6p9iInY5TqI7H9y',
        };

        // Initialize from existing values
        if (moodInput.value) {
            const btn = document.querySelector(`.mood-btn[data-mood="${moodInput.value}"]`);
            if (btn) btn.classList.add('active-mood');
        }
        if (spotifyInput.value) {
            showSpotifyPreview(spotifyInput.value);
            spotifySearch.value = spotifyInput.value;
        }

        // Mood Selection Logic
        moodBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const mood = btn.dataset.mood;
                moodInput.value = mood;
                
                // Visual Update
                moodBtns.forEach(b => b.classList.remove('active-mood'));
                btn.classList.add('active-mood');

                // Auto-sync Spotify if currently empty
                if (!spotifyInput.value && MOOD_TRACKS[mood]) {
                    updateSpotifyTrack(MOOD_TRACKS[mood]);
                }
            });
        });

        // Spotify Search / Input Logic
        spotifySearch.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (val.includes('spotify.com/track/')) {
                const id = val.split('/track/')[1].split('?')[0];
                updateSpotifyTrack(id);
            } else if (val.length > 10) {
                 updateSpotifyTrack(val);
            }
        });

        removeTrackBtn.addEventListener('click', () => {
            spotifyInput.value = '';
            spotifySearch.value = '';
            spotifyPreview.classList.add('hidden');
        });

        function updateSpotifyTrack(id) {
            spotifyInput.value = id;
            showSpotifyPreview(id);
        }

        function showSpotifyPreview(id) {
            spotifyPreview.classList.remove('hidden');
            // In a real app we'd fetch track meta, here we just show the ID
            document.getElementById('track-name').innerText = "Syncing Track...";
            document.getElementById('track-artist').innerText = id;
            
            // Artificial delay to feel like a "sync"
            setTimeout(() => {
                document.getElementById('track-name').innerText = "Spotify Synced";
                document.getElementById('track-art').classList.remove('animate-pulse');
                document.getElementById('track-art').classList.add('bg-green-500/20');
                document.getElementById('track-art').innerHTML = '<i data-lucide="check" class="w-5 h-5 text-green-500 m-auto"></i>';
                lucide.createIcons();
            }, 600);
        }

        // Initialize editor with content if exists
        if (hiddenContent.value) {
            editor.innerText = hiddenContent.value;
            updateStats();
        }

        // Sync content and update stats
        editor.addEventListener('input', () => {
            hiddenContent.value = editor.innerText;
            updateStats();
            debounceCheck();
        });

        function updateStats() {
            const text = editor.innerText.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCountDisplay.innerText = `${words} Words`;
        }

        // LanguageTool API Integration (Free Tier)
        let checkTimeout;
        function debounceCheck() {
            clearTimeout(checkTimeout);
            checkStatus.classList.remove('hidden');
            checkTimeout = setTimeout(performGrammarCheck, 2000);
        }

        async function performGrammarCheck() {
            const text = editor.innerText;
            if (!text || text.length < 5) {
                checkStatus.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}&language=en-US`
                });
                
                const data = await response.json();
                const issues = data.matches;
                
                if (issues.length > 0) {
                    issueCountDisplay.innerText = `${issues.length} Issues Found`;
                    issueCountDisplay.classList.add('text-amber-500');
                } else {
                    issueCountDisplay.innerText = 'Clear';
                    issueCountDisplay.classList.remove('text-amber-500');
                }
            } catch (error) {
                console.error('Check failed:', error);
            } finally {
                checkStatus.classList.add('hidden');
            }
        }

        // Mock Refine/AI function - in a real app this would call an LLM
        document.getElementById('refine-ai').addEventListener('click', async () => {
             const btn = document.getElementById('refine-ai');
             const originalText = btn.innerHTML;
             btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i> Refining...';
             lucide.createIcons();

             const text = editor.innerText;
             
             // Using LanguageTool to find and replace the first few issues as a "Fix All" demo
             const response = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `text=${encodeURIComponent(text)}&language=en-US`
             });
             const data = await response.json();
             
             let refinedText = text;
             // Apply replacements backwards to keep offsets valid
             data.matches.reverse().forEach(match => {
                 if (match.replacements && match.replacements.length > 0) {
                     const replacement = match.replacements[0].value;
                     refinedText = refinedText.substring(0, match.offset) + replacement + refinedText.substring(match.offset + match.length);
                 }
             });

             setTimeout(() => {
                editor.innerText = refinedText;
                hiddenContent.value = refinedText;
                updateStats();
                btn.innerHTML = originalText;
                issueCountDisplay.innerText = 'All Fixed';
                issueCountDisplay.classList.remove('text-amber-500');
                issueCountDisplay.classList.add('text-green-500');
                lucide.createIcons();
             }, 800);
        });

        // Focus title initially if empty
        const titleField = document.getElementById('id_title');
        if (!titleField.value) titleField.focus();
    });
</script>
{% endblock %}
