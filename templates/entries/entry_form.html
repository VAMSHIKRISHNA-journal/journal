{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit Entry{% else %}New Entry{% endif %} | Journal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with Breadcrumbs/Back -->
    <div class="mb-14 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{% url 'book-detail' book.id %}" class="flex items-center justify-center w-10 h-10 rounded-full border border-zinc-800 bg-zinc-900/50 hover:bg-zinc-800 transition-all text-zinc-400 hover:text-zinc-50">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-zinc-50">
                    {% if object %}Edit Entry{% else %}Write New Entry{% endif %}
                </h1>
                <p class="text-zinc-500 text-sm mt-1">In collection: <span class="text-zinc-400">{{ book.title }}</span></p>
            </div>
        </div>
    </div>

    <!-- The Editor Container -->
    <form id="editor-form" method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- Mood & Spotify Top Bar -->
        <div class="p-8 rounded-[2.5rem] bg-zinc-900/40 border border-zinc-800/50 backdrop-blur-md space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <!-- Mood Selector -->
                <div class="space-y-4">
                    <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest block">How are you feeling?</label>
                    <div class="flex flex-wrap gap-3" id="mood-picker">
                        {% for val, label in form.fields.mood.choices %}
                            {% if val %}
                            <button type="button" 
                                    class="mood-btn w-12 h-12 rounded-2xl border border-zinc-800 bg-zinc-950/50 hover:border-zinc-600 transition-all flex items-center justify-center text-xl group {% if form.initial.mood == val or form.instance.mood == val %}ring-2 ring-zinc-100 border-zinc-100{% endif %}"
                                    data-mood="{{ val }}"
                                    title="{{ label|slice:"2:" }}">
                                {{ label|slice:":2" }}
                            </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="hidden">{{ form.mood }}</div>
                </div>

                <!-- Spotify Integration -->
                <div class="space-y-4">
                    <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest block">Sync Spotify Track</label>
                    <div class="relative">
                        <input type="text" id="spotify-input" placeholder="Paste URL or Track ID" 
                               class="w-full bg-zinc-950/50 border border-zinc-800 rounded-2xl px-5 py-3 text-sm focus:ring-2 focus:ring-zinc-800 outline-none transition-all placeholder:text-zinc-700"
                               value="{{ form.instance.spotify_track_id|default:'' }}">
                    </div>
                    <div class="hidden">{{ form.spotify_track_id }}</div>
                    
                    <div id="spotify-preview" class="hidden animate-in fade-in slide-in-from-top-2 duration-500">
                        <iframe id="spotify-iframe" style="border-radius:16px" src="" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            {{ form.title|as_crispy_field }}
            {{ form.content|as_crispy_field }}
        </div>
        
        <div class="flex justify-end gap-4 pt-6">
            <a href="{% url 'book-detail' book.id %}" class="px-8 py-3 rounded-2xl text-sm font-bold text-zinc-500 hover:text-zinc-50 transition-colors">
                Discard
            </a>
            <button type="submit" class="bg-zinc-50 text-zinc-950 px-10 py-3 rounded-2xl text-sm font-black hover:bg-white transition-all shadow-[0_0_20px_rgba(255,255,255,0.05)] active:scale-95">
                {% if object %}Update Entry{% else %}Publish Entry{% endif %}
            </button>
        </div>
    </form>
</div>

<style>
    /* Crispy Form Overrides */
    .asteriskField { display: none; }
    #id_title, #id_content {
        background-color: transparent !important;
        border-color: #27272a !important; /* zinc-800 */
        border-radius: 1.5rem !important;
        padding: 1.25rem 1.5rem !important;
        color: #fafafa !important;
    }
    #id_title:focus, #id_content:focus {
        border-color: #52525b !important; /* zinc-600 */
        box-shadow: none !important;
    }
    #id_content { min-height: 400px; }
    label {
        font-size: 0.75rem !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
        color: #71717a !important; /* zinc-500 */
        margin-bottom: 0.75rem !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const moodBtns = document.querySelectorAll('.mood-btn');
        const moodInput = document.querySelector('select[name="mood"]');
        const spotifyInput = document.getElementById('spotify-input');
        const spotifyHidden = document.querySelector('input[name="spotify_track_id"]');
        const spotifyPreview = document.getElementById('spotify-preview');
        const spotifyIframe = document.getElementById('spotify-iframe');

        // Mood Selection
        moodBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                moodBtns.forEach(b => b.classList.remove('ring-2', 'ring-zinc-100', 'border-zinc-100'));
                btn.classList.add('ring-2', 'ring-zinc-100', 'border-zinc-100');
                moodInput.value = btn.dataset.mood;
            });
        });

        // Spotify Logic
        function updateSpotify(val) {
            let trackId = val;
            if (val.includes('track/')) {
                trackId = val.split('track/')[1].split('?')[0];
            }
            if (trackId && trackId.length > 10) {
                spotifyHidden.value = trackId;
                spotifyIframe.src = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`;
                spotifyPreview.classList.remove('hidden');
            } else {
                spotifyPreview.classList.add('hidden');
                spotifyHidden.value = '';
            }
        }

        spotifyInput.addEventListener('input', (e) => updateSpotify(e.target.value));
        if (spotifyInput.value) updateSpotify(spotifyInput.value);

        // Autofocus title
        const titleField = document.getElementById('id_title');
        if (titleField && !titleField.value) titleField.focus();
    });
</script>
{% endblock %}

