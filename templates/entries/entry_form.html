{% extends 'base.html' %}

{% block title %}{% if object %}Edit Entry{% else %}New Entry{% endif %} | Journal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with Breadcrumbs/Back -->
    <div class="mb-10 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{% url 'book-detail' book.id %}" class="flex items-center justify-center w-10 h-10 rounded-full border border-zinc-800 bg-zinc-900/50 hover:bg-zinc-800 transition-all text-zinc-400 hover:text-zinc-50">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-zinc-50">
                    {% if object %}Edit Entry{% else %}Write New Entry{% endif %}
                </h1>
                <p class="text-zinc-500 text-sm mt-1">In collection: <span class="text-zinc-400">{{ book.title }}</span></p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
             <div id="check-status" class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-[10px] font-mono text-zinc-500">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                Checking Grammar...
             </div>
             <button id="refine-ai" type="button" class="hidden md:flex items-center gap-2 px-4 py-1.5 rounded-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-xs font-bold text-zinc-300 transition-all hover:text-zinc-50">
                <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
                Refine All
             </button>
        </div>
    </div>

    <!-- The Editor Container -->
    <form id="editor-form" method="post" class="space-y-8">
        {% csrf_token %}
        {{ form.mood }}
        {{ form.spotify_track_id }}

        <!-- Mood & Spotify Top Bar -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 p-6 rounded-3xl bg-zinc-900/30 border border-zinc-800/50 backdrop-blur-sm">
            <div class="w-full md:w-auto">
                <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3 block">Current Mood</label>
                <div class="flex flex-wrap gap-2" id="mood-picker">
                    <button type="button" data-mood="happy" title="Happy" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ˜Š</button>
                    <button type="button" data-mood="sad" title="Sad" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ˜¢</button>
                    <button type="button" data-mood="energetic" title="Energetic" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">âš¡</button>
                    <button type="button" data-mood="calm" title="Calm" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ§˜</button>
                    <button type="button" data-mood="romantic" title="Romantic" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸ’–</button>
                    <button type="button" data-mood="productive" title="Productive" class="mood-btn w-10 h-10 rounded-xl border border-zinc-800 flex items-center justify-center text-xl hover:bg-zinc-800 transition-all opacity-40 grayscale hover:opacity-100 hover:grayscale-0">ðŸš€</button>
                </div>
            </div>

            <div class="w-full md:w-1/3">
                <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-3 block">Sync Spotify Song</label>
        
        <!-- Custom Mood and Spotify Integration -->
        <div class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 space-y-6 mb-8">
            <!-- Mood Selector -->
            <div>
                <label class="block text-sm font-semibold text-zinc-400 mb-3">How are you feeling?</label>
                <div class="grid grid-cols-5 gap-3">
                    {% for val, label in form.fields.mood.choices %}
                        {% if val %}
                        <button type="button" 
                                class="mood-btn px-3 py-4 rounded-xl border border-zinc-800 bg-zinc-950/50 hover:border-zinc-500 transition-all flex flex-col items-center gap-1 group {% if form.initial.mood == val %}active-mood{% endif %}"
                                data-mood="{{ val }}">
                            <span class="text-2xl group-hover:scale-110 transition-transform">{{ label|slice:":2" }}</span>
                            <span class="text-[10px] uppercase font-bold text-zinc-600">{{ label|slice:"2:" }}</span>
                        </button>
                        {% endif %}
                    {% endfor %}
                </div>
                {{ form.mood }}
            </div>

            <!-- Spotify Track Sync -->
            <div>
                <label class="block text-sm font-semibold text-zinc-400 mb-2">Sync a Spotify Song</label>
                <div class="flex gap-2">
                    <input type="text" id="spotify-search" placeholder="Paste Spotify URL or Track ID" 
                           class="flex-grow bg-zinc-950/50 border border-zinc-800 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-zinc-500 transition-colors">
                </div>
                
                <div id="spotify-preview" class="mt-4 p-4 rounded-xl bg-zinc-950 border border-zinc-800 hidden flex items-center gap-4">
                    <div id="track-art" class="w-12 h-12 rounded bg-zinc-800 animate-pulse flex items-center justify-center">
                        <i data-lucide="music" class="w-6 h-6 text-zinc-700"></i>
                    </div>
                    <div class="flex-grow">
                        <p id="track-name" class="text-xs font-bold text-zinc-200">Checking track...</p>
                        <p id="track-artist" class="text-[10px] text-zinc-500">Wait a moment</p>
                    </div>
                    <button type="button" id="remove-track" class="text-zinc-600 hover:text-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                {{ form.spotify_track_id }}
            </div>
        </div>

        {{ form.title|as_crispy_field }}
        {{ form.content|as_crispy_field }}
        
        <div class="flex justify-end gap-3 pt-4">
            <a href="{% url 'book-detail' book.id %}" class="px-6 py-2 rounded-xl text-sm font-medium text-zinc-400 hover:text-zinc-50 transition-colors">
                Cancel
            </a>
            <button type="submit" class="bg-zinc-50 text-zinc-950 px-8 py-2 rounded-xl text-sm font-bold hover:bg-zinc-200 transition-colors">
                {% if object %}Save Changes{% else %}Save Entry{% endif %}
            </button>
        </div>
    </form>
</div>

<style>
    .active-mood {
        border-color: #fafafa !important;
        background-color: rgba(250, 250, 250, 0.05) !important;
    }
</style>

<script>
             data.matches.reverse().forEach(match => {
                 if (match.replacements && match.replacements.length > 0) {
                     const replacement = match.replacements[0].value;
                     refinedText = refinedText.substring(0, match.offset) + replacement + refinedText.substring(match.offset + match.length);
                 }
             });

             setTimeout(() => {
                editor.innerText = refinedText;
                hiddenContent.value = refinedText;
                updateStats();
                btn.innerHTML = originalText;
                issueCountDisplay.innerText = 'All Fixed';
                issueCountDisplay.classList.remove('text-amber-500');
                issueCountDisplay.classList.add('text-green-500');
                lucide.createIcons();
             }, 800);
        });

        // Focus title initially if empty
        const titleField = document.getElementById('id_title');
        if (!titleField.value) titleField.focus();
    });
</script>
{% endblock %}
